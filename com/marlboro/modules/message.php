<?phpclass message extends App{	var $Request;	var $View;	var $user;	function __construct($req){		$this->Request = $req;		$this->View = new BasicView();		$this->setVar();		$this->user = $this->getUserInfo();	}	function home(){				$this->open(0);		$qry = "SELECT m.*,s.name FROM social_message m LEFT JOIN social_member s ON m.message_from=s.id WHERE message_to='".$this->user['id']."' AND message_status <> '2';";		$list = $this->fetch($qry,1);		$this->close();		$this->View->assign('list',$list);		return $this->View->toString(APPLICATION.'/inbox.html');	}	function read(){		$message_id = intval($this->Request->getParam('id'));		$this->open(0);		$qry = "SELECT m.*,s.name FROM social_message m LEFT JOIN social_member s ON m.message_from=s.id WHERE message_to='".$this->user['id']."' AND message_status <> '2' AND message_id=$message_id;";		$rs = $this->fetch($qry);				//ganti status message jadi sudah dibaca		if( $rs['message_status'] == '0' ){			$this->query("UPDATE social_message SET message_status='1' WHERE message_id=$message_id");		}				$this->View->assign('rs',$rs);		$this->close();		return $this->View->toString(APPLICATION.'/read-message.html');	}	function compose(){				$this->open(0);		$qry = "select m.name,m.id from social_connection c left join social_member m on c.connection_id=m.id where c.user_id='".$this->user['id']."';";		$list = $this->fetch($qry,1);		$this->View->assign('list',$list);		$this->close();		return $this->View->toString(APPLICATION.'/compose-message.html');	}	function sending(){				$_subject = $_POST['subject'];		$_to = intval($_POST['to']);		$_text = stripslashes(strip_tags($_POST['text']));				if( $_subject != '' && $_to > 0 && $_text != '' ){			$qry = "INSERT INTO social_message 						(message_to,message_from,message_date,message_subject,message_text)						VALUES						($_to,".$this->user['id'].",NOW(),'$_subject','$_text')";			$this->open(0);			if( $this->query($qry) ){				return $this->View->showMessage('Sending success','index.php?page=message');			}else{				return $this->View->showMessage('Sending failed, please try again!','index.php?page=message');			}			$this->close();		}else{			return $this->View->showMessage('Sending failed, please try again!','index.php?page=message');		}	}	function send(){		$this->open(0);		$qry = "SELECT m.*,s.name FROM social_message m LEFT JOIN social_member s ON m.message_to=s.id WHERE message_from='".$this->user['id']."' AND message_history <> '1';";		$list = $this->fetch($qry,1);		$this->close();		$this->View->assign('list',$list);		return $this->View->toString(APPLICATION.'/send-message.html');	}	function readsend(){		$message_id = intval($this->Request->getParam('id'));		$this->open(0);		$qry = "SELECT m.*,s.name FROM social_message m LEFT JOIN social_member s ON m.message_to=s.id WHERE message_from='".$this->user['id']."' AND message_history <> '1' AND message_id=$message_id;";		$rs = $this->fetch($qry);				$this->View->assign('rs',$rs);		$this->close();		return $this->View->toString(APPLICATION.'/read-send-message.html');	}}